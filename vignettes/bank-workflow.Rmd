---
title: "Bank Workflow" 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load your r2dii libraries
The first step in your analysis will be to load in the necessary r2dii packages 
into your current R session:

``` {r libraries}
library(r2dii.data)
library(r2dii.match)
library(r2dii.analysis)
```

we also recommend the following two `tidyverse` packages for data manipulation 
and plotting:

``` {r libraries}
library(dplyr)
library(ggplot2)
```

## Match your loanbook to climate-related asset-level data
First we need to match the loanbook to the ald
```{r match}
matched <- match_name(
  loanbook = loanbook_demo, 
  ald = ald_demo,
  overwrite = overwrite_demo
  ) %>%
  prioritize()

matched %>% head()
```

## Calculate targets
We can calculate market share scenario values at the portfolio level
```{r portfolio}
market_share_targets_portfolio <- matched %>% 
  target_market_share(
    ald = ald_demo, 
    scenario = scenario_demo_2020,
    region_isos = region_isos_demo
    )

market_share_targets_portfolio %>% head()
```

or at the company level 
```{r company}
market_share_targets_company <- matched %>% 
  target_market_share(
    ald = ald_demo, 
    scenario = scenario_demo_2020,
    region_isos = region_isos_demo,
    by_company = TRUE # setting this flag will output results at company-level
    )

market_share_targets_portfolio %>% head()
```

and we can calculate sda targets
```{r sda}
sda_targets <- matched %>% 
  target_sda(
    ald = ald_demo, 
    co2_intensity_scenario = co2_intensity_scenario_demo
    )

sda_targets %>% head()
```

## Plots
### Market Share plots
#### Sector-level technology mix
```{r technoloy mix portfolio, echo=FALSE}
market_share_targets_portfolio %>% 
  mutate(sector = ifelse(sector %in% c("coal", "oil and gas"), 
                         "fossil fuels", 
                         sector)) %>%
  dplyr::group_by(technology) %>% 
  ggplot(aes(x = weighted_production_metric, y = weighted_production_value, fill =
               technology)) + 
  geom_col(position = "fill") + 
  labs(x = "Metric", 
       y = "Weighted Production [%]") + 
  facet_grid(vars(sector))

```

#### Technology-level volume trajectory

```{r volume portfolio, echo=FALSE}
just_targets <- market_share_targets_portfolio %>% 
  dplyr::filter(grepl("target_",weighted_production_metric))

ceiling <- just_targets %>% 
  group_by(sector, technology, year, region, scenario_source) %>% 
  summarize(weighted_production_metric = "target_ceiling",
            weighted_production_value = max(weighted_production_value)) %>% 
  group_by(sector, technology, region, scenario_source) %>%  
  mutate(weighted_production_value = max(weighted_production_value))

just_data <- market_share_targets_portfolio %>% 
  dplyr::filter(!grepl("target_",weighted_production_metric))

just_targets %>% 
  rbind(ceiling) %>% 
  group_by(year) %>% 
  arrange(year, weighted_production_value) %>% 
  mutate(
    previous_value = lag(weighted_production_value, default = 0),
  ) %>% 
  filter(region == "global") %>% 
  ggplot(aes(x = year, 
             y = weighted_production_value, 
             color = weighted_production_metric, 
             fill = weighted_production_metric)) + 
  geom_ribbon(aes(ymin = previous_value, ymax = weighted_production_value)) +
  facet_wrap(vars(sector, technology), scales = "free")

market_share_targets_portfolio %>% 
  dplyr::filter(region == "global", 
                sector == "automotive",
                grepl("target_", weighted_production_metric)) %>%
  dplyr::group_by(vars(-c(weighted_production_metric, weighted_production_value))) %>% 
  dplyr::arrange(-weighted_production_value) %>% 
  ggplot(aes(x = year, 
             y = weighted_production_value, 
             color = weighted_production_metric, 
             fill = weighted_production_metric)) + 
  geom_area(position = "identity", alpha = 0.5) + 
  facet_wrap(vars(technology), scales = "free_y")

```

### SDA Target

```{r sda plot, echo=FALSE}
sda_targets %>% 
  group_by(emission_factor_metric) %>% 
  ggplot(aes(x = year, y = emission_factor_value, color = emission_factor_metric)) + 
  geom_line() + 
  facet_wrap(vars(sector))
```

